<!DOCTYPE html>
<html>
<head>
    <title>Revision Data</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_artifacts:[],items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}}],launch:function(){this._loadIterations()},_loadIterations:function(){var me=this,iterComboBox=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Iteration",labelAlign:"right",width:400,listeners:{ready:me._loadData,select:me._loadData,scope:me}});this.down("#pulldown-container").add(iterComboBox)},_loadData:function(){console.log("[2J");var selectedIterRef=this.down("#iteration-combobox").getRecord().get("_ref"),myFilters=this._getFilters(selectedIterRef);this.switch?(console.log("store exists"),this.artifacts.setFilter(myFilters),this.artifacts.load()):(console.log("new store"),this.artifacts=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,filters:myFilters,limit:1/0,fetch:["ObjectID","FormattedID","Name","RevisionHistory","Revisions","Description","User","ScheduleState"],listeners:{load:function(){this.switch=this.artifacts},scope:this}}),this.artifacts.load().then({success:this._getRevHistoryModel,scope:this}).then({success:this._onRevHistoryModelCreated,scope:this}).then({success:this._onModelLoaded,scope:this}).then({success:this._stitchDataTogether,scope:this}).then({success:function(results){this.grid||this._makeGrid(results)},scope:this,failure:function(){console.log("There's a rattle in the manifold...")}}))},_getFilters:function(iterationValue){var filterAccepted=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:"Accepted"}),filterLive=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:"Live"}),filterBacklog=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:"Backlog"}),filterInprogress=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:"In-Progress"}),iterationFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operation:"=",value:iterationValue});return console.log(iterationFilter.and(filterAccepted.or(filterLive).or(filterBacklog).or(filterInprogress))),iterationFilter},_getRevHistoryModel:function(artifacts){return this._artifacts=artifacts,Rally.data.ModelFactory.getModel({type:"RevisionHistory"})},_onRevHistoryModelCreated:function(model){var promises=[];return _.each(this._artifacts,function(artifact){var ref=artifact.get("RevisionHistory")._ref;promises.push(model.load(Rally.util.Ref.getOidFromRef(ref)))}),Deft.Promise.all(promises)},_onModelLoaded:function(histories){var promises=[];return _.each(histories,function(history){var revisions=history.get("Revisions");revisions.store=history.getCollection("Revisions",{fetch:["User","Description","CreationDate","RevisionNumber"]}),promises.push(revisions.store.load())}),Deft.Promise.all(promises)},_stitchDataTogether:function(revhistories){console.log(5,revhistories.length," ",revhistories);var artifactsWithRevs=[];_.each(this._artifacts,function(artifact){artifactsWithRevs.push({artifact:artifact.data})});var i=0;return _.each(revhistories,function(revisions){artifactsWithRevs[i].revisions=revisions,i++}),artifactsWithRevs},_makeGrid:function(artifactsWithRevs){console.log("@ G"),this.grid=Ext.create("Rally.ui.grid.Grid",{store:Ext.create("Rally.data.custom.Store",{data:artifactsWithRevs}),columnCfgs:[{text:"FormattedID",dataIndex:"artifact",renderer:function(value){var html;html="",html+='<div class="wrapper">';var authorDiv='<div class="name-t"><a href="https://rally1.rallydev.com/#/detail/userstory/'+value.ObjectID+'" target="_blank">'+value.FormattedID+"</a></div>";return html+=authorDiv,html+="</div>"}},{text:"Name",dataIndex:"artifact",flex:1,renderer:function(output){var html;html="",html+='<div class="wrapper">';var authorDiv='<div class="name-t">'+output.Name+"</div>";return html+=authorDiv,html+="</div>"}},{text:"Schedule State",dataIndex:"artifact",renderer:function(output){var html,cssResult;html="",output.ScheduleState.includes("Backlog")===!0&&(cssResult="Backlog"),output.ScheduleState.includes("Defined")===!0&&(cssResult="Defined"),output.ScheduleState.includes("In-Progress")===!0&&(cssResult="In-Progress"),output.ScheduleState.includes("Completed")===!0&&(cssResult="Completed"),output.ScheduleState.includes("Accepted")===!0&&(cssResult="Accepted"),output.ScheduleState.includes("Live")===!0&&(cssResult="Live"),html+='<div class="wrapper">';var authorDiv='<div class="a-t d-'+cssResult+'">'+output.ScheduleState+"</div>";return html+=authorDiv,html+="</div>"}},{text:"History",dataIndex:"revisions",flex:1,cls:"test",renderer:function(value){var html,cssResult,htmlSymbol;return html="",_.each(value,function(output){output.data.Description.includes("KANBAN")===!0&&(cssResult="kanban",htmlSymbol="9744"),output.data.Description.includes("RANK moved down")===!0&&(cssResult="rank-down",htmlSymbol="8681"),output.data.Description.includes("RANK moved up")===!0&&(cssResult="rank-up",htmlSymbol="8679"),output.data.Description.includes("Recovered from Recycle")===!0&&(cssResult="recycle-removed",htmlSymbol="9851"),output.data.Description.includes("Moved to Recycle")===!0&&(cssResult="recycle-added",htmlSymbol="9851"),output.data.Description.includes("DISCUSSION removed")!==!0&&output.data.Description.includes("NAME")!==!0||(cssResult="discussion-removed",htmlSymbol="9990"),output.data.Description.includes("DISCUSSION added")===!0&&(cssResult="discussion-added",htmlSymbol="9990"),output.data.Description.includes("REASON removed")===!0&&(cssResult="blocked-reason-removed",htmlSymbol="2600"),output.data.Description.includes("REASON added")!==!0&&output.data.Description.includes("BLOCKED REASON")!==!0||(cssResult="blocked-reason-added",htmlSymbol="9998"),output.data.Description.includes("BLOCKED changed from [true]")===!0&&(cssResult="blocked-false",htmlSymbol="9728"),output.data.Description.includes("BLOCKED changed from [false]")===!0&&(cssResult="blocked-true",htmlSymbol="9729"),output.data.Description.includes("FEATURE")===!0&&(cssResult="feature",htmlSymbol="9758"),output.data.Description.includes("TEST CASE")===!0&&(cssResult="test-added",htmlSymbol="9758"),output.data.Description.includes("OWNER")!==!0&&output.data.Description.includes("NAMM")!==!0||(cssResult="owner",htmlSymbol="9758"),output.data.Description.includes("READY changed from [false]")===!0&&(cssResult="ready-true",htmlSymbol="9734"),output.data.Description.includes("READY changed from [true]")===!0&&(cssResult="ready-false",htmlSymbol="9728"),output.data.Description.includes("EXPEDITE changed from [false]")===!0&&(cssResult="expedite-true",htmlSymbol="9734"),output.data.Description.includes("EXPEDITE changed from [true]")===!0&&(cssResult="expedite-false",htmlSymbol="9728"),output.data.Description.includes("ITERATION")!==!0&&output.data.Description.includes("RELEASE")!==!0||(cssResult="iter-release",htmlSymbol="9758"),output.data.Description.includes("PLAN ESTIMATE")===!0&&(cssResult="plan-estimate",htmlSymbol="9758"),output.data.Description.includes("COLOR")!==!0&&output.data.Description.includes("TASK")!==!0||(cssResult="colour",htmlSymbol="9758"),output.data.Description.includes("DESCRIPTION")!==!0&&output.data.Description.includes("NOTES")!==!0&&output.data.Description.includes("ACCEPTANCE CRITERIA")!==!0&&output.data.Description.includes("TAGS")!==!0||(cssResult="desc-added",htmlSymbol="9758"),output.data.Description.includes("Original")===!0&&(cssResult="Original",htmlSymbol="9827"),output.data.Description.includes("to [Backlog]")===!0&&(cssResult="Backlog",htmlSymbol="9744"),output.data.Description.includes("to [Defined]")===!0&&(cssResult="Defined",htmlSymbol="9744"),output.data.Description.includes("to [In-Progress")===!0&&(cssResult="In-Progress",htmlSymbol="9744"),output.data.Description.includes("to [Completed")===!0&&(cssResult="Completed",htmlSymbol="9744"),output.data.Description.includes("to [Accepted")===!0&&(cssResult="Accepted",htmlSymbol="9744"),output.data.Description.includes("to [Live]")===!0&&(cssResult="Live",htmlSymbol="9745"),html+='<div class="wrapper">';var numberDiv='<div class="n-t n-'+cssResult+'">'+output.data.RevisionNumber+"</div>",symbolDiv='<div class="g-t"><span style="font-family:Wingdings">&#'+htmlSymbol+"</span></div>",authorDiv='<div class="a-t d-'+cssResult+'">'+output.data.User._refObjectName+"</div>",DescriptionDiv='<div class="d-t d-'+cssResult+'">'+output.data.Description+"</div>";html+=numberDiv+symbolDiv+authorDiv+DescriptionDiv,html+="</div>"}),html}}]}),this.add(this.grid)}});

            Rally.launchApp('CustomApp', {
                name:"Revision Data",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-mmm .x-grid-row .x-grid-data-row .x-grid-row-over{background:black}.wrapper{display:flex;margin-bottom:1px}.underline{width:100%;height:10px}.n-t{height:100%;width:30px;padding:4px;margin-right:1px;font-weight:bold;text-align:center;border-radius:20px;font-size:14px}.a-t{height:100%;width:120px;padding:4px;margin-right:1px;font-weight:bold;text-align:center;border-radius:20px;font-size:14px}.name-t{height:100%;padding:4px;flex:2;font-weight:bold;text-align:left;font-size:14px;border-radius:20px;padding:4px 10px 4px 10px;background:repeating-linear-gradient(45deg, #f6f6f6, #f6f6f6 10px, #efefef 10px, #efefef 20px)}.g-t{height:100%;width:30px;padding:4px;font-weight:bold;text-align:center;font-size:14px}.d-t{flex:1;height:100%;padding:4px 10px 4px 10px;width:30px;border-radius:20px;font-size:14px;font-weight:bold}.n-Original{color:black;background:#F0F0F0}.d-Original{color:black;background:repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #d2d2d2 10px, #d2d2d2 20px)}.n-Backlog{color:black;background:#F7C430}.d-Backlog{color:black;background:repeating-linear-gradient(45deg, #f7c430, #f7c430 10px, #f7c430 10px, #f7c430 20px)}.n-Defined{color:black;background:#F99221}.d-Defined{color:black;background:repeating-linear-gradient(45deg, #f99221, #f99221 10px, #f99221 10px, #f99221 20px)}.n-In-Progress{color:black;background:#E63B8A}.d-In-Progress{color:black;background:repeating-linear-gradient(45deg, #e63b8a, #e63b8a 10px, #e63b8a 10px, #e63b8a 20px)}.n-Completed{color:black;background:#53C8F2}.d-Completed{color:black;background:repeating-linear-gradient(45deg, #53c8f2, #53c8f2 10px, #53c8f2 10px, #53c8f2 20px)}.n-Accepted{color:black;background:#C0FF00}.d-Accepted{color:black;background:repeating-linear-gradient(45deg, #c0ff00, #c0ff00 10px, #c0ff00 10px, #c0ff00 20px)}.n-Live{color:black;background:#C0FF00}.d-Live{color:black;background:repeating-linear-gradient(45deg, #c0ff00, #c0ff00 10px, #c0ff00 10px, #c0ff00 20px)}.n-desc-added{color:black;background:#F3EF4B}.d-desc-added{color:black;background:repeating-linear-gradient(45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-colour{color:black;background:#F3EF4B}.d-colour{color:black;background:repeating-linear-gradient(45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-plan-estimate{color:black;background:#F3EF4B}.d-plan-estimate{color:black;background:repeating-linear-gradient(45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-iter-release{color:black;background:#F3EF4B}.d-iter-release{color:black;background:repeating-linear-gradient(45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-ready-true{color:white;background:#6CCA2C}.d-ready-true{color:white;background:repeating-linear-gradient(-45deg, #6cca2c, #6cca2c 10px, #6cca2c 10px, #6cca2c 20px)}.n-ready-false{color:black;background:#6CCA2C}.d-ready-false{color:black;background:repeating-linear-gradient(45deg, #6cca2c, #6cca2c 10px, #6cca2c 10px, #6cca2c 20px)}.n-expedite-true{color:white;background:#F51B1B}.d-expedite-true{color:white;background:repeating-linear-gradient(-45deg, #f51b1b, #f51b1b 10px, #d81818 10px, #d81818 20px)}.n-expedite-false{color:black;background:#6CCA2C}.d-expedite-false{color:black;background:repeating-linear-gradient(45deg, #6cca2c, #6cca2c 10px, #6cca2c 10px, #6cca2c 20px)}.n-owner{color:black;background:#F3EF4B}.d-owner{color:black;background:repeating-linear-gradient(45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-feature{color:white;background:#E63B8A}.d-feature{color:white;background:repeating-linear-gradient(45deg, #e63b8a, #e63b8a 10px, #e63b8a 10px, #e63b8a 20px)}.n-blocked-true{color:white;background:#F51B1B}.d-blocked-true{color:white;background:repeating-linear-gradient(-45deg, #f51b1b, #f51b1b 10px, #d81818 10px, #d81818 20px)}.n-blocked-false{color:black;background:#6CCA2C}.d-blocked-false{color:black;background:repeating-linear-gradient(45deg, #6cca2c, #6cca2c 10px, #6cca2c 10px, #6cca2c 20px)}.n-blocked-reason-removed{color:white;background:#C6D614}.d-blocked-reason-removed{color:white;background:repeating-linear-gradient(45deg, #c6d614, #c6d614 10px, #b2c10f 10px, #b2c10f 20px)}.n-blocked-reason-added{color:white;background:#F51B1B}.d-blocked-reason-added{color:white;background:repeating-linear-gradient(-45deg, #f51b1b, #f51b1b 10px, #d81818 10px, #d81818 20px)}.n-test-added{color:black;background:#F3EF4B}.d-test-added{color:black;background:repeating-linear-gradient(-45deg, #f3ef4b, #f3ef4b 10px, #f3ef4b 10px, #f3ef4b 20px)}.n-discussion-added{color:white;background:#351B75}.d-discussion-added{color:white;background:repeating-linear-gradient(45deg, #351b75, #351b75 10px, #351b75 10px, #351b75 20px)}.n-discussion-removed{color:white;background:#351B75}.d-discussion-removed{color:white;background:repeating-linear-gradient(-45deg, #351b75, #351b75 10px, #351b75 10px, #351b75 20px)}.n-recycle-added{color:white;background:#2A95FF}.d-recycle-added{color:white;background:repeating-linear-gradient(45deg, #2a95ff, #2a95ff 10px, #2589eb 10px, #2589eb 20px)}.n-recycle-removed{color:white;background:#2589EB}.d-recycle-removed{color:white;background:repeating-linear-gradient(45deg, #2589eb, #2589eb 10px, #2a95ff 10px, #2a95ff 20px)}.n-rank-up{color:black;background:#FFD300}.d-rank-up{color:black;background:repeating-linear-gradient(45deg, #ffd300, #ffd300 10px, #f4ca00 10px, #f4ca00 20px)}.n-rank-down{color:black;background:#FF9500}.d-rank-down{color:black;background:repeating-linear-gradient(45deg, #ff9500, #ff9500 10px, #ee8b00 10px, #ee8b00 20px)}.n-kanban{color:black;background:#7D64B1}.d-kanban{color:black;background:repeating-linear-gradient(45deg, #7d64b1, #7d64b1 10px, #7d64b1 10px, #7d64b1 20px)}
    </style>
</head>
<body>
</body>
</html>
